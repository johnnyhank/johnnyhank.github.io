{% include base_path %}

<!-- 全局音乐播放器 -->
<div id="globalMusicPlayer" class="music-player-container">
  <div class="music-player">
    <div class="player-toggle" id="musicToggleBtn">
      <i class="fas fa-music"></i>
    </div>
    <div class="player-controls" id="playerControls">
      <div class="song-info">
        <div class="song-title" id="songTitle">背景音乐播放器1</div>
        <div class="song-artist" id="songArtist">点击播放按钮开始</div>
      </div>
      <div class="control-buttons">
        <button id="prevBtn" title="上一首"><i class="fas fa-step-backward"></i></button>
        <button id="playPauseBtn" title="播放/暂停"><i class="fas fa-play"></i></button>
        <button id="nextBtn" title="下一首"><i class="fas fa-step-forward"></i></button>
      </div>
      <div class="volume-control">
        <i class="fas fa-volume-down"></i>
        <input type="range" id="volumeSlider" min="0" max="100" value="30">
        <i class="fas fa-volume-up"></i>
      </div>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="time-display">
          <span id="currentTime">0:00</span> / <span id="totalTime">0:00</span>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="backgroundAudio" preload="none"></audio>

<style>
.music-player-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  font-family: 'Helvetica Neue', Arial, sans-serif;
}

.music-player {
  background: rgba(44, 62, 80, 0.95);
  backdrop-filter: blur(10px);
  border-radius: 15px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  transition: all 0.3s ease;
}

.player-toggle {
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #ecf0f1;
  font-size: 1.5em;
  border-radius: 15px;
  transition: all 0.3s ease;
}

.player-toggle:hover {
  background: rgba(52, 73, 94, 0.8);
  transform: scale(1.05);
}

.player-controls {
  display: none;
  padding: 20px;
  min-width: 320px;
  color: #ecf0f1;
}

.player-controls.active {
  display: block;
}

.song-info {
  text-align: center;
  margin-bottom: 15px;
}

.song-title {
  font-size: 1.1em;
  font-weight: 600;
  margin-bottom: 5px;
  color: #ecf0f1;
}

.song-artist {
  font-size: 0.9em;
  color: #bdc3c7;
}

.control-buttons {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
  margin-bottom: 15px;
}

.control-buttons button {
  background: none;
  border: none;
  color: #ecf0f1;
  font-size: 1.2em;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.control-buttons button:hover {
  background: rgba(52, 73, 94, 0.6);
  transform: scale(1.1);
}

#playPauseBtn {
  font-size: 1.4em;
  width: 50px;
  height: 50px;
}

.volume-control {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}

.volume-control i {
  color: #bdc3c7;
  font-size: 0.9em;
}

#volumeSlider {
  flex: 1;
  height: 4px;
  border-radius: 2px;
  background: #34495e;
  outline: none;
  -webkit-appearance: none;
}

#volumeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: #3498db;
  cursor: pointer;
}

.progress-container {
  margin-bottom: 10px;
}

.progress-bar {
  width: 100%;
  height: 4px;
  background: #34495e;
  border-radius: 2px;
  cursor: pointer;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: #3498db;
  border-radius: 2px;
  width: 0%;
  transition: width 0.3s ease;
}

.time-display {
  display: flex;
  justify-content: space-between;
  font-size: 0.8em;
  color: #95a5a6;
  margin-top: 5px;
}

/* 移动端适配 */
@media (max-width: 768px) {
  .music-player-container {
    bottom: 10px;
    right: 10px;
  }
  
  .player-controls {
    min-width: 280px;
    padding: 15px;
  }
  
  .player-toggle {
    width: 50px;
    height: 50px;
    font-size: 1.3em;
  }
}
</style>

<script>
// 全局音乐播放器系统
(function() {
    // 音乐播放列表 - 使用更可靠的测试音频
    const playlist = [
        {
            title: "测试音频 1",
            artist: "Test Audio",
            src: "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmIeAjiN0/PNeSsFJHnI7t2VQAoUXrTq6alUEwlBn+D0wWIfBOe1Y7L0onKPf3xKlYfG6fywF4gHlX+ITWlUhPaZCj4GjG5HjlVllNMjUrMnPHAmOI5fNzY5ZHtmPCEqPIIwcmKOJ4wjjGOKNUYXl/xOEGNqnWQ0YCFjKKgMXzJFPyWONnUnPi6UBUIojC0sNYJKBTJMLdJJLYElJJhGHQ9Mljwqq+PFTCLEkQomCTgqXGrDsVsKT2lK1HlV"
        },
        {
            title: "自然音效",
            artist: "Nature",
            src: "https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.wav"
        },
        {
            title: "短音频测试",
            artist: "Test",
            src: "https://www2.cs.uic.edu/~i101/SoundFiles/CantinaBand60.wav"
        }
    ];
    
    let currentSongIndex = 0;
    let isPlaying = false;
    let audio = null; // 初始化为null，在DOM加载后再获取
    
    console.log('Music player script loaded'); // 添加脚本加载确认
    
    // 从localStorage恢复播放状态
    function restorePlayerState() {
        console.log('恢复播放状态...');
        const savedState = JSON.parse(localStorage.getItem('musicPlayerState') || '{}');
        if (savedState.currentSong !== undefined) {
            currentSongIndex = savedState.currentSong;
            console.log('恢复歌曲索引:', currentSongIndex);
        }
        if (savedState.volume !== undefined && audio) {
            const volumeSlider = document.getElementById('volumeSlider');
            if (volumeSlider) {
                volumeSlider.value = savedState.volume;
                audio.volume = savedState.volume / 100;
                console.log('恢复音量:', savedState.volume);
            }
        }
        if (savedState.currentTime !== undefined && savedState.currentTime > 0 && audio) {
            // 播放时间恢复放在loadSong中处理
            console.log('准备恢复播放时间:', savedState.currentTime);
        }
    }
    
    // 保存播放状态
    function savePlayerState() {
        const state = {
            currentSong: currentSongIndex,
            volume: document.getElementById('volumeSlider').value,
            currentTime: audio.currentTime,
            isPlaying: isPlaying
        };
        localStorage.setItem('musicPlayerState', JSON.stringify(state));
    }
    
    // 加载歌曲
    function loadSong(index) {
        console.log('loadSong called with index:', index);
        if (index < 0 || index >= playlist.length) {
            console.error('Invalid song index:', index);
            return;
        }
        
        const song = playlist[index];
        console.log('Loading song:', song);
        audio.src = song.src;
        document.getElementById('songTitle').textContent = song.title;
        document.getElementById('songArtist').textContent = song.artist;
        
        // 添加音频加载事件监听
        audio.addEventListener('loadstart', function() {
            console.log('Audio loading started');
        });
        
        audio.addEventListener('canplay', function() {
            console.log('Audio can play');
        });
        
        audio.addEventListener('error', function(e) {
            console.error('Audio loading error:', e);
            document.getElementById('songTitle').textContent = '加载失败';
            document.getElementById('songArtist').textContent = '无法加载音频文件';
        });
        
        // 恢复播放时间
        const savedState = JSON.parse(localStorage.getItem('musicPlayerState') || '{}');
        if (savedState.currentTime && index === savedState.currentSong) {
            audio.addEventListener('canplay', function setTime() {
                audio.currentTime = savedState.currentTime;
                console.log('Restored playback time:', savedState.currentTime);
                audio.removeEventListener('canplay', setTime);
            });
        }
    }
    
    // 上一首
    function previousSong() {
        currentSongIndex = (currentSongIndex - 1 + playlist.length) % playlist.length;
        loadSong(currentSongIndex);
        if (isPlaying) {
            audio.play();
        }
        savePlayerState();
    }
    
    // 下一首
    function nextSong() {
        currentSongIndex = (currentSongIndex + 1) % playlist.length;
        loadSong(currentSongIndex);
        if (isPlaying) {
            audio.play();
        }
        savePlayerState();
    }
    
    // 设置音量
    function setVolume(value) {
        audio.volume = value / 100;
        savePlayerState();
    }
    
    // 播放/暂停切换
    function togglePlayPause() {
        console.log('togglePlayPause called, isPlaying:', isPlaying);
        
        if (audio.src === '' || audio.src === window.location.href) {
            console.log('Loading song:', currentSongIndex);
            loadSong(currentSongIndex);
        }
        
        if (isPlaying) {
            audio.pause();
            document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-play"></i>';
            isPlaying = false;
            console.log('Audio paused');
        } else {
            console.log('Attempting to play audio, src:', audio.src);
            audio.play().then(() => {
                document.getElementById('playPauseBtn').innerHTML = '<i class="fas fa-pause"></i>';
                isPlaying = true;
                console.log('Audio playing successfully');
            }).catch(e => {
                console.error('播放失败:', e);
                // 更友好的错误提示
                document.getElementById('songTitle').textContent = '播放失败';
                document.getElementById('songArtist').textContent = '请检查网络连接或音频文件';
                alert('音频播放失败，可能的原因：\n1. 网络连接问题\n2. 音频文件不存在\n3. 浏览器阻止了自动播放\n\n请刷新页面后重试，或手动点击播放按钮。');
            });
        }
        savePlayerState();
    }
    
    // 暴露给全局的函数（为了向后兼容和调试）
    window.togglePlayPause = togglePlayPause;
    window.previousSong = previousSong; 
    window.nextSong = nextSong;
    window.setVolume = setVolume;
    
    // 添加全局切换函数用于调试
    window.toggleMusicPlayer = function() {
        console.log('全局toggleMusicPlayer被调用');
        const controls = document.getElementById('playerControls');
        if (controls) {
            controls.classList.toggle('active');
            console.log('全局函数切换后类名:', controls.className);
            return true;
        } else {
            console.error('全局函数: 找不到playerControls元素');
            return false;
        }
    };
    
    // 调试函数
    window.debugMusicPlayer = function() {
        console.log('=== 音乐播放器调试信息 ===');
        console.log('音乐图标按钮:', document.getElementById('musicToggleBtn'));
        console.log('控制面板:', document.getElementById('playerControls'));
        console.log('播放按钮:', document.getElementById('playPauseBtn'));
        console.log('音频元素:', document.getElementById('backgroundAudio'));
        console.log('当前audio变量:', audio);
        console.log('播放列表:', playlist);
        console.log('当前歌曲索引:', currentSongIndex);
        console.log('播放状态:', isPlaying);
        console.log('=========================');
    };
    
    // 测试播放函数
    window.testPlay = function() {
        console.log('测试播放函数被调用');
        if (!audio) {
            console.error('Audio元素未找到');
            return;
        }
        togglePlayPause();
    };
    
    // 初始化事件监听器
    function initEventListeners() {
        console.log('开始初始化事件监听器...');
        
        // 音乐播放器切换按钮
        const toggleBtn = document.getElementById('musicToggleBtn');
        console.log('找到切换按钮:', toggleBtn);
        
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function(e) {
                console.log('音乐图标被点击');
                const controls = document.getElementById('playerControls');
                console.log('找到控制面板:', controls);
                if (controls) {
                    controls.classList.toggle('active');
                    console.log('切换后类名:', controls.className);
                }
            });
            console.log('切换按钮事件监听器已绑定');
        } else {
            console.error('未找到音乐切换按钮!');
        }
        
        // 播放/暂停按钮
        const playPauseBtn = document.getElementById('playPauseBtn');
        console.log('找到播放按钮:', playPauseBtn);
        if (playPauseBtn) {
            playPauseBtn.addEventListener('click', function() {
                console.log('播放按钮被点击');
                togglePlayPause();
            });
            console.log('播放按钮事件监听器已绑定');
        } else {
            console.error('未找到播放按钮!');
        }
        
        // 上一首按钮
        const prevBtn = document.getElementById('prevBtn');
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                console.log('上一首按钮被点击');
                previousSong();
            });
            console.log('上一首按钮事件监听器已绑定');
        }
        
        // 下一首按钮
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                console.log('下一首按钮被点击');
                nextSong();
            });
            console.log('下一首按钮事件监听器已绑定');
        }
        
        // 音量滑块
        const volumeSlider = document.getElementById('volumeSlider');
        if (volumeSlider) {
            volumeSlider.addEventListener('input', function() {
                console.log('音量滑块被调整到:', this.value);
                setVolume(this.value);
            });
            console.log('音量滑块事件监听器已绑定');
        }
        
        console.log('所有事件监听器初始化完成');
    }
    
    // 进度条控制
    function initProgressBar() {
        const progressBar = document.getElementById('progressBar');
        if (progressBar) {
            progressBar.addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                audio.currentTime = pos * audio.duration;
            });
        }
    }
    
    // 初始化音频事件监听器
    function initAudioEvents() {
        if (!audio) return;
        
        // 更新进度条
        audio.addEventListener('timeupdate', function() {
            if (audio.duration) {
                const progress = (audio.currentTime / audio.duration) * 100;
                const progressFill = document.getElementById('progressFill');
                const currentTimeEl = document.getElementById('currentTime');
                const totalTimeEl = document.getElementById('totalTime');
                
                if (progressFill) progressFill.style.width = progress + '%';
                if (currentTimeEl) currentTimeEl.textContent = formatTime(audio.currentTime);
                if (totalTimeEl) totalTimeEl.textContent = formatTime(audio.duration);
                
                // 定期保存播放进度
                if (Math.floor(audio.currentTime) % 5 === 0) {
                    savePlayerState();
                }
            }
        });
        
        // 歌曲结束时播放下一首
        audio.addEventListener('ended', function() {
            console.log('Song ended, playing next');
            nextSong();
        });
        
        console.log('Audio events initialized');
    }
    
    // 格式化时间
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return mins + ':' + (secs < 10 ? '0' : '') + secs;
    }
    
    // 页面加载时初始化
    function initMusicPlayer() {
        console.log('Initializing music player...');
        
        // 获取audio元素
        audio = document.getElementById('backgroundAudio');
        if (!audio) {
            console.error('Audio element not found!');
            return false;
        }
        console.log('Audio element found:', audio);
        
        // 初始化事件监听器
        initEventListeners();
        
        // 初始化音频事件
        initAudioEvents();
        
        // 初始化进度条事件
        initProgressBar();
        
        // 恢复播放状态和加载歌曲
        try {
            restorePlayerState();
            loadSong(currentSongIndex);
        } catch (e) {
            console.error('Error during state restoration:', e);
        }
        
        // 恢复播放状态
        const savedState = JSON.parse(localStorage.getItem('musicPlayerState') || '{}');
        if (savedState.isPlaying && savedState.currentTime > 0) {
            console.log('Auto-resuming playback in 2 seconds...');
            setTimeout(() => {
                togglePlayPause();
            }, 2000);
        }
        
        console.log('Music player initialized successfully');
        return true;
    }
    
    // 等待DOM完全加载
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMusicPlayer);
    } else {
        // DOM已经加载完成
        initMusicPlayer();
    }
    
    // 添加window load事件作为备用
    window.addEventListener('load', function() {
        console.log('Window loaded, checking music player...');
        if (!audio) {
            console.log('Music player not initialized, retrying...');
            setTimeout(initMusicPlayer, 500);
        }
    });
    
    // 页面卸载前保存状态
    window.addEventListener('beforeunload', function() {
        savePlayerState();
    });
    
    // 定期保存状态
    setInterval(savePlayerState, 10000); // 每10秒保存一次
})();
</script>

{% if site.author.github or site.author.bitbucket or site.atom_feed.hide != true %}
<div class="page__footer-follow">
  <ul class="social-icons">
    {% if site.data.ui-text[site.locale].follow_label %}
      <li><strong>{{ site.data.ui-text[site.locale].follow_label }}</strong></li>
    {% endif %}
    {% if site.author.github %}
      <li><a href="http://github.com/{{ site.author.github }}"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    {% endif %}
    {% if site.author.bitbucket %}
      <li><a href="http://bitbucket.org/{{ site.author.bitbucket }}"><i class="fab fa-bitbucket" aria-hidden="true"></i> Bitbucket</a></li>
    {% endif %}
    {% if site.atom_feed.hide != true %}
    <li><a href="{% if site.atom_feed.path %}{{ site.atom_feed.path }}{% else %}{{ base_path }}/feed.xml{% endif %}"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> {{ site.data.ui-text[site.locale].feed_label | default: "Feed" }}</a></li>
    {% endif %}
  </ul>
</div>
{% endif %}

<div class="page__footer-copyright">
  &copy; {{ site.time | date: '%Y' }} {{ site.name | default: site.title }}, {{ site.data.ui-text[site.locale].powered_by | default: "Powered by" }} <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.<br />
  Site last updated {{ "now" | date: '%Y-%m-%d' %}}
</div>
